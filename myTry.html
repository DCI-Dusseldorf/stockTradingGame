<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <button id="buy">buy</button>
    <button id="sell">sell</button>
    <button id="refreshPortfolio">Refresh Portfolio</button>
  </body>
  <script>
     // Class to get data from Finnhub
     class StockData {
       key = "btgepcv48v6thhaqa2lg";
       today = new Date().getTime();

       constructor() {
         //this.symbol = symbol;
       }
       async getData(symbol) {
         try {
           const url1 = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=1577833200&to=${this.today}&token=${this.key}`;
           const response = await fetch(url1);
           const data = await response.json();
           const chartData = [];
           for (let i = 0; i < data.t.length; i++) {
             chartData.push([data.t[i] * 1000, data.c[i]]);
           }
           return chartData;
         } catch (error) {
           console.log(error);
         }
       }
       async getCurrentPrice(symbol) {
         return await this.getData(symbol).then((data) => data.pop()[1]);
       }
     }

    // let FETCHDATA = new StockData();
     //predata.getData().then((data) => console.log(data));

     //Class to buy or sell
     class BuyOrSell extends StockData {
       buyValue = Number;
       sellValue = Number;
       async executeBuy(symbol, quantity) {
         const buyPrice = await super.getCurrentPrice(symbol);
         this.buyValue = buyPrice * quantity;
         let cash = PORTFOLIO.retrieveCash();
         if (this.buyValue < cash) {
           console.log("Buy order executed successfully");
           PORTFOLIO.addToPortfolio(symbol, buyPrice, quantity);
           cash = cash - this.buyValue;
           PORTFOLIO.setCash(cash);          
         } else {
           console.log("Insufficient balance to execute Buy order");
         }
         PORTFOLIO.computePortfValue();
       }
       async executeSell(symbol, quantity) {
         const sellPrice = await super.getCurrentPrice(symbol);
         this.sellValue = sellPrice * quantity;
         let cash = JSON.parse(PORTFOLIO.retrieveCash());
         const portfQuantity = PORTFOLIO.computeQuantity();
         if (quantity <= portfQuantity[symbol]) {
           console.log("Sell order executed successfully");
           PORTFOLIO.addToPortfolio(symbol, sellPrice, quantity * -1);
           cash = cash + this.sellValue;
           PORTFOLIO.setCash(cash);
         } else {
           console.log("Insufficient quantity to execute Sell order");
         }
         PORTFOLIO.computePortfValue();
       }
     }

     // class to include in portfolio
     class Portfolio extends StockData {
       cash = 1000000;
       stocks = [];
       // constructor() {
       //   this.cash = 1000000;
       //   localStorage.setItem("cash", this.cash);
       // }

       retrieveCash() {
         return localStorage.getItem("cash");
       }

       setCash(cash) {
         return localStorage.setItem("cash", cash);
       }

       computeQuantity() {
         const quantities = {};
         let tempArray = [];
         this.stocks = JSON.parse(localStorage.getItem("myPortfolio"));
         this.stocks.forEach(([symbol, { buyPrice, quantity }], index) => {
           tempArray = this.stocks[index];
           if (quantities[symbol]) {
             quantities[symbol] += parseInt(quantity);
           } else {
             quantities[symbol] = parseInt(quantity);
           }
         });
         return quantities;
       }

       addToPortfolio(symbol, buyPrice, quantity) {
         //write all the 3 values in local storage
         this.stocks.push([symbol, { buyPrice, quantity }]);
         localStorage.setItem("myPortfolio", JSON.stringify(this.stocks));
       }
       
        computePortfValue() {

        let portfolioValue = 0;
        const portfQuantity =this.computeQuantity();     
        Object.keys(portfQuantity).forEach(async(symbol)=>{
          const currentPrice = await super.getCurrentPrice(symbol);          
          portfolioValue += portfQuantity[symbol]*currentPrice;
          localStorage.setItem('PortFolio Value',portfolioValue);
        });
        //console.log(this.portfolioValue);
        }
     }

     // Main routine;
     let PORTFOLIO = new Portfolio();

     const btnBuy = document.getElementById("buy");
     const btnSell = document.getElementById("sell");
     const btnrefreshPortfolio = document.getElementById('refreshPortfolio');

     btnBuy.addEventListener("click", (e) => {
       e.preventDefault();
       const exec = new BuyOrSell();
       let symbol = prompt("please enter the symbol", "AAPL");
       let quantity = prompt("please enter the quantity", 1);

       exec.executeBuy(symbol, quantity);
     });
     btnSell.addEventListener("click", (e) => {
       e.preventDefault();
       const exec = new BuyOrSell();
       let symbol = prompt("please enter the symbol", "AAPL");
       let quantity = prompt("please enter the quantity", 1);
       exec.executeSell(symbol, quantity);
     });
     btnrefreshPortfolio.addEventListener("click", (e) => {
       e.preventDefault();
      PORTFOLIO.computePortfValue();
       
     });
   
  </script>
</html>

  </script>
</html>
